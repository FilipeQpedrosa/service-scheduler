generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BaseModel {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)

  @@map("base_model")
}

model SystemSettings {
  id                  String      @id @default(cuid())
  key                 String      @unique
  value               Json
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  lastModifiedBy      String
  isDeleted           Boolean     @default(false)
  lastModifiedByAdmin SystemAdmin @relation(fields: [lastModifiedBy], references: [id])

  @@index([key])
  @@map("system_settings")
}

model SystemAdmin {
  id            String                 @id @default(cuid())
  email         String                 @unique
  name          String
  role          AdminRole
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  isDeleted     Boolean                @default(false)
  activities    AdminActivity[]
  verifications BusinessVerification[]
  settings      SystemSettings[]
  businesses    Business[]             @relation("SystemAdminToBusinesses")

  @@index([email])
  @@map("system_admins")
}

model BusinessVerification {
  id          String             @id @default(cuid())
  businessId  String             @unique
  status      VerificationStatus
  submittedAt DateTime           @default(now())
  verifiedAt  DateTime?
  verifiedBy  String?
  documents   Json?
  notes       String?
  isDeleted   Boolean            @default(false)
  business    Business           @relation(fields: [businessId], references: [id])
  systemAdmin SystemAdmin?       @relation(fields: [verifiedBy], references: [id])

  @@index([businessId])
  @@index([status])
  @@map("business_verifications")
}

model Business {
  id                   String                @id @default(cuid())
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  name                 String
  email                String                @unique
  phone                String?
  address              String?
  website              String?
  description          String?
  logo                 String?
  settings             Json?
  type                 BusinessType          @default(HAIR_SALON)
  passwordHash         String
  appointments         Appointment[]
  clients              Client[]
  services             Service[]
  staff                Staff[]
  verification         BusinessVerification?
  dataAccessLogs       DataAccessLog[]
  featureConfiguration FeatureConfiguration?
  patientDataRules     PatientDataRule[]
  patientRelationships PatientRelationship[]
  securitySettings     SecuritySettings?
  serviceCategories    ServiceCategory[]
  staffPermissions     StaffPermission[]
  patients             Patient[]             @relation("BusinessToPatient")
  systemAdmins         SystemAdmin[]         @relation("SystemAdminToBusinesses")

  @@index([email])
}

model SecuritySettings {
  id                        String   @id @default(cuid())
  businessId                String   @unique
  requireMFA                Boolean  @default(false)
  sensitiveDataAccessExpiry Int?
  autoRevokeInactiveAccess  Boolean  @default(true)
  inactivityThreshold       Int      @default(30)
  enforceIPRestriction      Boolean  @default(false)
  allowedIPs                String[]
  requireAccessReason       Boolean  @default(true)
  enableAccessLogs          Boolean  @default(true)
  defaultDataRetentionDays  Int      @default(365)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  isDeleted                 Boolean  @default(false)
  business                  Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@map("security_settings")
}

model Staff {
  id                         String                       @id @default(cuid())
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  name                       String
  email                      String                       @unique
  phone                      String?
  password                   String
  role                       StaffRole                    @default(STANDARD)
  businessId                 String
  appointments               Appointment[]
  business                   Business                     @relation(fields: [businessId], references: [id])
  availability               StaffAvailability?
  PatientRelationshipToStaff PatientRelationshipToStaff[]
  dataAccessLogs             DataAccessLog[]
  patientDataRules           PatientDataRule[]
  relationshipNotes          RelationshipNote[]
  permissions                StaffPermission[]
  services                   Service[]                    @relation("StaffServices")

  @@index([businessId])
  @@index([email])
}

model Service {
  id           String           @id @default(cuid())
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  name         String
  description  String?
  duration     Int
  price        Float
  businessId   String
  categoryId   String?
  appointments Appointment[]
  business     Business         @relation(fields: [businessId], references: [id])
  category     ServiceCategory? @relation(fields: [categoryId], references: [id])
  staff        Staff[]          @relation("StaffServices")

  @@index([businessId])
  @@index([categoryId])
}

model Client {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  name         String
  email        String        @unique
  phone        String?
  businessId   String
  preferences  Json?
  appointments Appointment[]
  business     Business      @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([email])
}

model Patient {
  id                String                @id @default(cuid())
  name              String
  email             String                @unique
  phone             String?
  dateOfBirth       DateTime?
  gender            String?
  address           String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  isDeleted         Boolean               @default(false)
  createdBy         String?
  lastModifiedBy    String?
  status            PatientStatus         @default(ACTIVE)
  notes             String?
  flags             PatientFlag[]
  appointments      Appointment[]
  PatientToProvider PatientToProvider[]
  accessLogs        DataAccessLog[]
  dataRules         PatientDataRule[]
  preferences       PatientPreference?
  relationships     PatientRelationship?
  sensitiveInfo     PatientSensitiveInfo?
  paymentMethods    PaymentMethod[]
  reviews           Review[]
  businesses        Business[]            @relation("BusinessToPatient")

  @@index([email])
  @@index([status])
  @@index([isDeleted])
  @@index([createdBy])
  @@index([lastModifiedBy])
  @@map("patients")
}

model PatientSensitiveInfo {
  id               String    @id @default(cuid())
  email            String
  notes            String?
  medicalInfo      String?
  documents        Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  isDeleted        Boolean   @default(false)
  patientId        String    @unique
  encryptionStatus Boolean   @default(true)
  lastAccessedAt   DateTime?
  accessLog        Json?
  patient          Patient   @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([isDeleted])
  @@map("patient_sensitive_info")
}

model ServiceCategory {
  id             String    @id @default(cuid())
  name           String
  description    String?
  color          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isDeleted      Boolean   @default(false)
  createdBy      String?
  lastModifiedBy String?
  businessId     String
  services       Service[]
  business       Business  @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([isDeleted])
  @@index([createdBy])
  @@index([lastModifiedBy])
  @@map("service_categories")
}

model PatientRelationship {
  id                         String                       @id @default(cuid())
  patientId                  String                       @unique
  businessId                 String
  staffId                    String?
  status                     PatientStatus                @default(ACTIVE)
  relationshipStartDate      DateTime                     @default(now())
  lastVisit                  DateTime?
  visitFrequency             Int?
  lifetimeValue              Decimal?
  preferences                Json?
  internalNotes              String?
  flags                      PatientFlag[]
  createdAt                  DateTime                     @default(now())
  updatedAt                  DateTime                     @updatedAt
  PatientRelationshipToStaff PatientRelationshipToStaff[]
  business                   Business                     @relation(fields: [businessId], references: [id])
  patient                    Patient                      @relation(fields: [patientId], references: [id])
  noteHistory                RelationshipNote[]
  visitHistory               VisitHistory[]

  @@map("patient_relationships")
}

model VisitHistory {
  id                  String              @id @default(cuid())
  relationshipId      String
  visitDate           DateTime
  serviceType         String
  staffNotes          String?
  patientFeedback     String?
  followUpRequired    Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  patientRelationship PatientRelationship @relation(fields: [relationshipId], references: [id])

  @@map("visit_history")
}

model RelationshipNote {
  id                  String              @id @default(cuid())
  relationshipId      String
  noteType            NoteType
  content             String
  createdById         String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  createdBy           Staff               @relation(fields: [createdById], references: [id])
  patientRelationship PatientRelationship @relation(fields: [relationshipId], references: [id])

  @@map("relationship_notes")
}

model StaffPermission {
  id          String      @id @default(cuid())
  staffId     String
  businessId  String
  resource    String
  accessLevel AccessLevel
  conditions  Json?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  expiresAt   DateTime?
  business    Business    @relation(fields: [businessId], references: [id])
  staff       Staff       @relation(fields: [staffId], references: [id])

  @@unique([staffId, resource])
  @@map("staff_permissions")
}

model DataAccessLog {
  id         String         @id @default(cuid())
  businessId String
  staffId    String
  patientId  String
  accessType DataAccessType
  resource   String
  reason     String
  ipAddress  String?
  userAgent  String?
  successful Boolean
  timestamp  DateTime       @default(now())
  business   Business       @relation(fields: [businessId], references: [id])
  patient    Patient        @relation(fields: [patientId], references: [id])
  staff      Staff          @relation(fields: [staffId], references: [id])

  @@map("data_access_logs")
}

model PatientDataRule {
  id          String      @id @default(cuid())
  businessId  String
  patientId   String
  staffId     String?
  resource    String
  accessLevel AccessLevel
  startDate   DateTime    @default(now())
  endDate     DateTime?
  reason      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  business    Business    @relation(fields: [businessId], references: [id])
  patient     Patient     @relation(fields: [patientId], references: [id])
  staff       Staff?      @relation(fields: [staffId], references: [id])

  @@map("patient_data_rules")
}

model Provider {
  id                String              @id @default(cuid())
  name              String
  email             String              @unique
  PatientToProvider PatientToProvider[]
}

model FeatureConfiguration {
  id         String    @id @default(cuid())
  businessId String    @unique
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  business   Business  @relation(fields: [businessId], references: [id])
  features   Feature[]

  @@map("feature_configurations")
}

model Feature {
  id               String               @id @default(cuid())
  key              String
  name             String
  description      String?
  enabled          Boolean              @default(true)
  requiresApproval Boolean              @default(false)
  configurationId  String
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  options          FeatureOption[]
  configuration    FeatureConfiguration @relation(fields: [configurationId], references: [id])

  @@unique([configurationId, key])
  @@map("features")
}

model FeatureOption {
  id        String   @id @default(cuid())
  key       String
  name      String
  enabled   Boolean  @default(true)
  featureId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  feature   Feature  @relation(fields: [featureId], references: [id])

  @@unique([featureId, key])
  @@map("feature_options")
}

model StaffAvailability {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  staffId   String   @unique
  schedule  Json     @default("{}")
  staff     Staff    @relation(fields: [staffId], references: [id])

  @@index([staffId])
}

model Review {
  id            String      @id @default(cuid())
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  patientId     String
  appointmentId String      @unique
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  patient       Patient     @relation(fields: [patientId], references: [id])

  @@map("reviews")
}

model PatientPreference {
  id                 String   @id @default(cuid())
  patientId          String   @unique
  emailNotifications Boolean  @default(true)
  smsNotifications   Boolean  @default(false)
  reminderTime       Int      @default(24)
  marketingEmails    Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  patient            Patient  @relation(fields: [patientId], references: [id])

  @@map("patient_preferences")
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  message   String
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  metadata  Json?

  @@map("notifications")
}

model PaymentMethod {
  id        String   @id @default(cuid())
  patientId String
  type      String
  details   Json
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id])

  @@map("payment_methods")
}

model AdminActivity {
  id        String      @id @default(cuid())
  adminId   String
  action    String
  details   Json?
  createdAt DateTime    @default(now())
  admin     SystemAdmin @relation(fields: [adminId], references: [id])

  @@map("admin_activities")
}

model RecurringAppointment {
  id           String             @id @default(cuid())
  frequency    RecurringFrequency
  interval     Int
  daysOfWeek   Int[]
  startDate    DateTime
  endDate      DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  appointments Appointment[]

  @@map("recurring_appointments")
}

model BackupStatus {
  id        String   @id @default(cuid())
  status    String
  timestamp DateTime @default(now())
  details   String?
  filename  String
  checksum  String?
  size      BigInt?
  duration  Int?

  @@index([status])
  @@index([timestamp])
  @@map("backup_status")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Appointment {
  id                     String                @id @default(cuid())
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  scheduledFor           DateTime
  duration               Int
  status                 AppointmentStatus     @default(PENDING)
  notes                  String?
  staffId                String
  clientId               String
  serviceId              String
  businessId             String
  patientId              String
  recurringAppointmentId String?
  business               Business              @relation(fields: [businessId], references: [id])
  client                 Client                @relation(fields: [clientId], references: [id])
  patient                Patient               @relation(fields: [patientId], references: [id])
  recurringAppointment   RecurringAppointment? @relation(fields: [recurringAppointmentId], references: [id])
  service                Service               @relation(fields: [serviceId], references: [id])
  staff                  Staff                 @relation(fields: [staffId], references: [id])
  review                 Review?

  @@index([staffId])
  @@index([clientId])
  @@index([serviceId])
  @@index([businessId])
  @@index([patientId])
  @@index([recurringAppointmentId])
}

model PatientRelationshipToStaff {
  A                     String
  B                     String
  patient_relationships PatientRelationship @relation(fields: [A], references: [id], onDelete: Cascade)
  Staff                 Staff               @relation(fields: [B], references: [id], onDelete: Cascade)

  @@unique([A, B], map: "_PatientRelationshipToStaff_AB_unique")
  @@index([B], map: "_PatientRelationshipToStaff_B_index")
  @@map("_PatientRelationshipToStaff")
}

model PatientToProvider {
  A        String
  B        String
  patients Patient  @relation(fields: [A], references: [id], onDelete: Cascade)
  Provider Provider @relation(fields: [B], references: [id], onDelete: Cascade)

  @@unique([A, B], map: "_PatientToProvider_AB_unique")
  @@index([B], map: "_PatientToProvider_B_index")
  @@map("_PatientToProvider")
}

enum BusinessType {
  HAIR_SALON
  BARBERSHOP
  NAIL_SALON
  PHYSIOTHERAPY
  PSYCHOLOGY
  OTHER
}

enum StaffRole {
  ADMIN
  MANAGER
  STANDARD
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  TRANSFER
}

enum PatientStatus {
  PENDING
  ACTIVE
  INACTIVE
  VIP
  BLOCKED
}

enum NoteType {
  GENERAL
  PREFERENCE
  INCIDENT
  FEEDBACK
  FOLLOW_UP
  SPECIAL_REQUEST
}

enum PatientFlag {
  ALLERGIES
  MEDICAL_CONDITION
  PAYMENT_ISSUES
  SPECIAL_CARE
  VIP_TREATMENT
  CANCELLED_FREQUENTLY
  RESCHEDULE_FREQUENTLY
}

enum AccessLevel {
  FULL
  RESTRICTED
  BASIC
  NONE
}

enum DataAccessType {
  VIEW
  EDIT
  EXPORT
  DELETE
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
}

enum VerificationStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum BusinessStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}
